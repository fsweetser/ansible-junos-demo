---
- hosts: all
  connection: local
  gather_facts: no
  vars:
    reboot_wait_time: 10
  vars_files:
    - global_vars/images.yml
    
  tasks:   
    - name: Determining Junos OS information by role
      action: set_fact 
      args:
        junos_os_version: "{{ IMAGE_TAGS[junos_image_tag].version }}"
        junos_os_package: "{{ IMAGE_TAGS[junos_image_tag].package }}"
            
    - name: Installing Junos OS, please wait, this could take a bit ...
      action: junos_install_os
      args:
        hostname: "{{ inventory_hostname }}"  
        version: "{{ junos_os_version }}"
        package: "{{ junos_os_package }}"
        dir: "{{ IMAGE_DIR }}" 
        reboot: True
      register: junos_os_installed
      
    - name: Giving some time for target to reboot ...
      pause: seconds="{{ reboot_wait_time }}"
      when: junos_os_installed.changed == True
      
    - name: Waiting for target to be back online, NETCONF ready
      wait_for: host="{{ inventory_hostname }}" port=830
      when: junos_os_installed.changed == True

    - name: Contacting target to obtain Junos facts
      junos_get_facts: target={{ inventory_hostname }}
      register: junos_facts
      
